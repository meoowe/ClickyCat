name: Export Desktop

on:
  push:
    branches: [ master ]

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: ClickyCat
  TAG: v2.0.2

jobs:
  export-windows:
    name: Windows Export 🗔
    runs-on: ubuntu-latest
    container:
      image: docker://barichello/godot-ci:4.3
    steps:
      - name: Setup WINE and rcedit 🍷
        run: |
          chown root:root -R ~
          godot --headless --quit
          echo 'export/windows/wine = "/usr/bin/wine64-stable"' >> ~/.config/godot/editor_settings-4.3.tres
          echo 'export/windows/rcedit = "/opt/rcedit.exe"' >> ~/.config/godot/editor_settings-4.3.tres
      - name: Checkout 🛎️
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Setup 💻
        run: |
          mkdir -v -p build/${EXPORT_NAME}-Windows-64bit build/${EXPORT_NAME}-Windows-32bit ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Import resources once 📦
        continue-on-error: true
        run: godot --headless -v --import
      - name: 🛠️ Windows Build
        run: |
          mkdir -v -p builds/windows
          EXPORT_DIR="$(readlink -f build)"
          cd .
          godot --headless --verbose --export-release "Windows Desktop" "builds/windows/ClickyCat-${{env.TAG}}.exe"
      - name: 📦 Zip Windows Folder
        working-directory: .
        run: |
          cd .
          rm -rf Windows-ClickyCat-${{env.TAG}}.zip
          zip -r Windows-ClickyCat-${{env.TAG}} builds/windows/ClickyCat-${{env.TAG}}.exe
      - name: Upload Release Asset 🚀
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          tag: ${{env.TAG}}
          overwrite: true
          file_glob: true

  export-linux:
    name: Linux Export 🐧
    runs-on: ubuntu-latest
    container:
      image: docker://barichello/godot-ci:4.3
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Setup 💻
        run: |
          mkdir -v -p build/${EXPORT_NAME}-Linux-64bit build/${EXPORT_NAME}-Linux-32bit build/${EXPORT_NAME}-Linux-ARM64 build/${EXPORT_NAME}-Linux-ARM32 ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Import resources once 📦
        continue-on-error: true
        run: godot --headless -v --import
      - name: Linux Build 🔧
        run: |
          mkdir -v -p builds/linux
          EXPORT_DIR="$(readlink -f build)"
          cd .
          godot --headless -v --export-release "Linux" "./build/linux/ClickyCat-${{env.TAG}}.x86_64"
        continue-on-error: true
      - name: Give execute permission ☑️
        run: |
          chmod +x /builds/linux/ClickyCat-${{env.TAG}}.x86_64
      - name: Create tar.gz archive 🗜️
        run: |
          cd .
          tar zcvf builds/linux/ClickyCat-${{env.TAG}}.tar.gz builds/linux/ClickyCat-${{env.TAG}}.x86_64
      - name: Upload Release Asset 🚀
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./builds/linux/ClickyCat-${{env.TAG}}.x86_64
          tag: ${{env.TAG}}
          overwrite: true
          file_glob: true

