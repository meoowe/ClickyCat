name: Export Desktop

on:
  push:
    branches: [ master ]

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: ClickyCat
  TAG: v2.0.2

jobs:
  export-windows:
    name: Windows Export üóî
    runs-on: ubuntu-latest
    container:
      image: docker://barichello/godot-ci:4.3
    steps:
      - name: Setup WINE and rcedit üç∑
        run: |
          chown root:root -R ~
          godot --headless --quit
          echo 'export/windows/wine = "/usr/bin/wine64-stable"' >> ~/.config/godot/editor_settings-4.3.tres
          echo 'export/windows/rcedit = "/opt/rcedit.exe"' >> ~/.config/godot/editor_settings-4.3.tres
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Setup üíª
        run: |
          mkdir -v -p build/${EXPORT_NAME}-Windows-64bit  ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
      - name: Import resources once üì¶
        continue-on-error: true
        run: godot --headless -v --import
      - name: üõ†Ô∏è Windows Build
        run: |
          mkdir -v -p builds/windows
          EXPORT_DIR="$(readlink -f build)"
          cd .
          godot --headless --verbose --export-release "Windows Desktop" "builds/windows/ClickyCat-${{env.TAG}}.exe"
      - name: üì¶ Zip Windows Folder
        working-directory: .
        run: |
          cd .
          rm -rf Windows-ClickyCat-${{env.TAG}}.zip
          zip -r Windows-ClickyCat-${{env.TAG}} builds/windows/ClickyCat-${{env.TAG}}.exe
      - name: Upload Release Asset üöÄ
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./build/*
          tag: ${{env.TAG}}
          overwrite: true
          file_glob: true

  export-linux:
    name: Linux Export üêß
    runs-on: ubuntu-latest
    steps:
      # Always include the checkout step so that 
      # your project is available for Godot to export
    - name: checkout
      uses: actions/checkout@v4
    - name: üì§export game
      id: export
      # Use latest version (see releases for all versions)
      uses: firebelley/godot-export@v6.0.0
      with:
        # Defining all the required inputs
        godot_executable_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4-dev3/Godot_v4.4-dev3_linux.x86_64.zip
        godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4-dev3/Godot_v4.4-dev3_export_templates.tpz
        relative_project_path: ./
        archive_output: true

      # This release action has worked well for me. However, you can most likely use any release action of your choosing.
      # https://github.com/ncipollo/release-action
    - name: create release
      uses: ncipollo/release-action@v1.14.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        generateReleaseNotes: true
        tag: ${{ env.TAG }}
        artifacts: ${{ steps.export.outputs.archive_directory }}/*
